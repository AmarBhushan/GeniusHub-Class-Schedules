<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>GeniusHub Scheduler</title>
    
    <!-- PWA & Mobile Configuration -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="GeniusHub">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#4338ca">

    <!-- Embedded Icon (SVG Data URI) -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='120' fill='%234338ca'/%3E%3Cpath d='M160 140h192c11 0 20 9 20 20v32c0 11-9 20-20 20h-22v100h20c11 0 20 9 20 20v32c0 11-9 20-20 20h-20v40c0 11-9 20-20 20h-32c-11 0-20-9-20-20v-40h-80v40c0 11-9 20-20 20h-32c-11 0-20-9-20-20v-40h-20c-11 0-20-9-20-20v-32c0-11 9-20 20-20h20V212h-22c-11 0-20-9-20-20v-32c0-11 9-20 20-20h192z' fill='white' fill-opacity='0.2'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='central' text-anchor='middle' font-family='sans-serif' font-weight='bold' font-size='220' fill='white'%3EGH%3C/text%3E%3C/svg%3E">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='120' fill='%234338ca'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='central' text-anchor='middle' font-family='sans-serif' font-weight='bold' font-size='220' fill='white'%3EGH%3C/text%3E%3C/svg%3E">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: env(safe-area-inset-bottom);
            transition: background-color 0.5s ease;
        }

        /* --- Global Body Themes (Page Background) --- */
        .page-theme-morning { background-color: #f0f9ff; }   /* Sky 50 */
        .page-theme-afternoon { background-color: #fffaf0; } /* Floral White/Warm */
        .page-theme-night { background-color: #cbd5e1; }     /* Slate 300 */

        /* --- Card Color Themes --- */
        .time-morning { 
            background-color: #e0f2fe; border-color: #7dd3fc; color: #0c4a6e;
        }
        .time-afternoon { 
            background-color: #fff7ed; border-color: #fdba74; color: #9a3412;
        }
        .time-night { 
            background-color: #e2e8f0; border-color: #94a3b8; color: #334155;
        }
        .status-booked { 
            background-color: #fee2e2 !important; 
            border-color: #ef4444 !important;     
            color: #991b1b !important;            
            box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.2) !important;
        }
        
        .custom-scrollbar::-webkit-scrollbar { width: 0px; background: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .modal-overlay {
            backdrop-filter: blur(4px);
            transition: opacity 0.2s ease-in-out;
            z-index: 100;
        }
        .safe-top { padding-top: max(1.5rem, env(safe-area-inset-top) + 1rem); }
        .safe-bottom { padding-bottom: max(1.5rem, env(safe-area-inset-bottom) + 1rem); }
        
        /* Tab Animation */
        .tab-active { background-color: #4f46e5; color: white; border-color: #4f46e5; transform: scale(1.05); }
        .tab-inactive { background-color: #f1f5f9; color: #64748b; border-color: #cbd5e1; }
    </style>
</head>
<body id="app-body" class="bg-slate-50 min-h-screen text-slate-900">

    <!-- Booking Modal (New Assignment) -->
    <div id="modal-overlay" class="fixed inset-0 bg-slate-900/60 modal-overlay hidden items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-[2rem] shadow-2xl p-6 space-y-4 animate-in fade-in zoom-in duration-200">
            <div class="text-center">
                <h3 id="modal-title" class="text-lg font-black text-slate-800">Assign Student</h3>
                <p class="text-xs text-slate-500 font-medium">Book this session</p>
            </div>
            <div class="space-y-3">
                <div class="space-y-1">
                    <label class="text-[10px] font-bold uppercase text-slate-400 ml-1">Student Name</label>
                    <input type="text" id="student-name-input" placeholder="e.g. Rahul Sharma" 
                        class="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl outline-none focus:border-indigo-500 transition-all font-bold text-slate-800">
                </div>
                
                <div class="space-y-1">
                    <label class="text-[10px] font-bold uppercase text-slate-400 ml-1">Their Time Zone</label>
                    <select id="student-tz-input" class="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl outline-none focus:border-indigo-500 font-medium text-sm text-slate-800">
                        <!-- Populated by JS -->
                    </select>
                </div>

                <div class="space-y-1">
                    <label class="text-[10px] font-bold uppercase text-slate-400 ml-1">Note (Optional)</label>
                    <input type="text" id="student-note-input" placeholder="e.g. Calculus Basics" 
                        class="w-full p-3 bg-slate-50 border-2 border-slate-100 rounded-xl outline-none focus:border-indigo-500 transition-all text-sm text-slate-800">
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="closeModal()" class="flex-1 py-3 font-bold text-slate-400 bg-slate-50 rounded-xl hover:bg-slate-100">Cancel</button>
                <button onclick="saveBooking()" class="flex-1 py-3 font-bold text-white bg-indigo-600 rounded-xl shadow-lg shadow-indigo-100 hover:bg-indigo-700">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Manage Session Modal (WhatsApp/Unbook) -->
    <div id="manage-overlay" class="fixed inset-0 bg-slate-900/60 modal-overlay hidden items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-[2rem] shadow-2xl p-6 space-y-4 animate-in fade-in zoom-in duration-200">
            <div class="text-center mb-4">
                <h3 id="manage-title" class="text-xl font-black text-slate-800">Manage Session</h3>
                <p id="manage-subtitle" class="text-sm text-slate-500">Student Name</p>
            </div>

            <!-- WhatsApp Button -->
            <button onclick="sendWhatsappReminder()" class="w-full py-4 bg-green-500 hover:bg-green-600 text-white rounded-2xl shadow-lg shadow-green-100 flex items-center justify-center gap-2 transition-transform active:scale-95">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-8.683-2.031-9.672-.272-.989-.471-1.486-.891-1.486-.322 0-.694.025-1.066.025-.371 0-.966.149-1.462.693-.496.545-1.907 1.857-1.907 4.529 0 2.673 1.957 5.244 2.229 5.641.272.397 3.812 5.925 9.387 8.237 3.279 1.36 4.585 1.36 6.196 1.137 1.61-.223 2.946-1.634 3.342-2.748.397-1.114.397-2.056.273-2.254z"/></svg>
                <span class="font-bold text-lg">Send Reminder</span>
            </button>
            <p class="text-[10px] text-center text-slate-400 px-4">Opens WhatsApp with meeting link & time pre-filled.</p>

            <div class="h-px bg-slate-100 my-2"></div>

            <div class="flex gap-2">
                <button onclick="closeManageModal()" class="flex-1 py-3 font-bold text-slate-400 bg-slate-50 rounded-xl hover:bg-slate-100">Back</button>
                <button onclick="confirmUnbook()" class="flex-1 py-3 font-bold text-red-500 bg-red-50 rounded-xl hover:bg-red-100">Cancel Class</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-overlay" class="fixed inset-0 bg-slate-900/60 modal-overlay hidden items-center justify-center p-4">
        <div class="bg-white w-full max-w-md h-[85vh] rounded-[2rem] shadow-2xl flex flex-col overflow-hidden animate-in fade-in zoom-in duration-200">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-black text-slate-800">Configuration</h3>
                <button onclick="closeSettingsModal()" class="text-slate-400 p-2 hover:bg-slate-100 rounded-full">‚úï</button>
            </div>
            
            <div class="flex-grow overflow-y-auto p-6 space-y-8 custom-scrollbar">
                
                <!-- Meeting Link Section -->
                <section class="space-y-2 p-4 bg-indigo-50 rounded-2xl border border-indigo-100">
                    <h4 class="text-xs font-black uppercase tracking-widest text-indigo-600">Default Meeting Link</h4>
                    <p class="text-xs text-indigo-800/70 mb-2">Sent in WhatsApp reminders.</p>
                    <input type="text" id="setting-meeting-link" placeholder="e.g. meet.google.com/abc-xyz" 
                        class="w-full p-3 bg-white border border-indigo-200 rounded-xl text-sm text-indigo-900 font-medium focus:ring-2 focus:ring-indigo-500 outline-none">
                </section>

                <section class="space-y-4">
                    <div class="flex justify-between items-end">
                        <h4 class="text-xs font-black uppercase tracking-widest text-indigo-600">Daily Slots (IST)</h4>
                        <span class="text-[10px] text-slate-400">24h format</span>
                    </div>
                    <div id="settings-slots-list" class="space-y-2"></div>
                    <div class="flex gap-2">
                        <input type="time" id="new-slot-input" class="flex-grow p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none font-bold text-slate-800">
                        <button onclick="addSlot()" class="bg-indigo-600 text-white px-6 rounded-xl font-bold hover:bg-indigo-700">+</button>
                    </div>
                </section>

                <section class="space-y-4">
                    <h4 class="text-xs font-black uppercase tracking-widest text-indigo-600">Time Zones</h4>
                    <div id="settings-tz-list" class="space-y-2"></div>
                    <div class="space-y-2 pt-2">
                        <input type="text" id="new-tz-label" placeholder="Label (e.g. New York)" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none text-sm">
                        <div class="flex gap-2">
                            <input type="text" id="new-tz-value" placeholder="Zone ID (e.g. America/New_York)" class="flex-grow p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none text-sm font-mono">
                            <button onclick="addTimezone()" class="bg-indigo-600 text-white px-6 rounded-xl font-bold hover:bg-indigo-700">+</button>
                        </div>
                    </div>
                </section>
            </div>

            <div class="p-4 bg-slate-50 border-t">
                <button onclick="closeSettingsModal()" class="w-full py-4 bg-slate-900 text-white rounded-2xl font-black shadow-xl hover:bg-slate-800">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="main-container" class="max-w-md mx-auto bg-white min-h-screen shadow-2xl flex flex-col transition-all duration-500">
        
        <!-- Header -->
        <header class="bg-indigo-700 px-6 pb-4 pt-10 safe-top text-white flex justify-between items-center rounded-b-[2rem] shadow-lg sticky top-0 z-50">
            <div>
                <h1 class="text-2xl font-bold tracking-tight">GeniusHub</h1>
                <p class="text-[10px] text-indigo-200 uppercase font-bold tracking-widest">Instructor Dashboard</p>
            </div>
            <button onclick="openSettingsModal()" class="p-3 bg-white/10 rounded-2xl hover:bg-white/20 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
            </button>
        </header>

        <!-- New Day Selector (Horizontal) -->
        <div class="px-4 py-4 bg-white/50 backdrop-blur-sm sticky top-[90px] z-40 border-b border-slate-100">
            <div id="day-nav" class="flex overflow-x-auto gap-2 no-scrollbar pb-1">
                <!-- Populated by JS -->
            </div>
        </div>

        <!-- Controls -->
        <div id="controls" class="px-5 py-2 space-y-4">
            <div class="space-y-2">
                <div class="relative">
                    <select id="timezone-select" onchange="updateView()" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl shadow-sm focus:ring-2 focus:ring-indigo-500 outline-none appearance-none font-bold text-indigo-900 cursor-pointer text-sm">
                    </select>
                    <div class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400">‚ñº</div>
                </div>
            </div>
            
            <div class="text-center">
                <div class="text-xs text-slate-400 font-medium">
                    Current IST: <span id="current-ist-clock" class="font-mono font-bold text-indigo-600">--:--</span>
                </div>
            </div>
        </div>

        <!-- Schedule Grid (Single Day View) -->
        <div id="schedule-container" class="flex-grow p-4 space-y-4 pb-4 custom-scrollbar overflow-y-auto">
        </div>

        <!-- Footer -->
        <footer class="p-6 safe-bottom border-t border-slate-200 bg-white mt-auto">
            <button onclick="openResetModal()" class="w-full py-4 text-xs text-red-500 font-bold uppercase tracking-widest bg-red-50 rounded-2xl hover:bg-red-100 transition-colors">
                Reset Weekly Schedule
            </button>
        </footer>
    </div>

    <!-- Reset Confirmation -->
    <div id="reset-overlay" class="fixed inset-0 bg-slate-900/60 modal-overlay hidden items-center justify-center p-4">
        <div class="bg-white w-full max-sm rounded-[2rem] shadow-2xl p-6 space-y-4 text-center animate-in fade-in zoom-in duration-200">
            <h3 class="text-lg font-black text-slate-800">Reset Week?</h3>
            <p class="text-sm text-slate-500">Clears all assignments.</p>
            <div class="flex gap-2">
                <button onclick="closeResetModal()" class="flex-1 py-3 font-bold text-slate-400 hover:bg-slate-50 rounded-xl">Cancel</button>
                <button onclick="confirmReset()" class="flex-1 py-3 font-bold text-white bg-red-500 rounded-xl shadow-lg shadow-red-200 hover:bg-red-600">Reset</button>
            </div>
        </div>
    </div>

    <script>
        const daysFull = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        const daysShort = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        
        let config = {
            slots: ["04:30", "05:30", "06:30", "07:30", "18:00", "20:00"],
            meetingLink: "", // Stores the Google Meet/Zoom link
            timezones: [
                { label: "India (IST)", value: "Asia/Kolkata" },
                { label: "USA (East Coast)", value: "America/New_York" },
                { label: "USA (Central)", value: "America/Chicago" },
                { label: "USA (West Coast)", value: "America/Los_Angeles" },
                { label: "UK (London)", value: "Europe/London" },
                { label: "Dubai (GST)", value: "Asia/Dubai" },
                { label: "Singapore / HK", value: "Asia/Singapore" },
                { label: "Australia (Sydney)", value: "Australia/Sydney" }
            ]
        };

        let schedule = {};
        let activeEdit = null; // { day, index }
        let currentViewDayIndex = 0; // 0 = Monday, etc.

        // --- INIT ---

        function initData() {
            const savedConfig = localStorage.getItem('geniushub_config_v2');
            if (savedConfig) config = JSON.parse(savedConfig);

            const savedSchedule = localStorage.getItem('geniushub_schedule_v6');
            if (savedSchedule) {
                schedule = JSON.parse(savedSchedule);
                syncScheduleWithSlots();
            } else {
                rebuildSchedule();
            }

            // Determine current day in IST to auto-focus
            const nowIST = new Date().toLocaleString('en-US', { timeZone: 'Asia/Kolkata', weekday: 'long' });
            const dayIdx = daysFull.indexOf(nowIST);
            if (dayIdx !== -1) {
                currentViewDayIndex = dayIdx;
            }
        }

        function rebuildSchedule() {
            schedule = {};
            daysFull.forEach(day => {
                schedule[day] = config.slots.map(time => ({
                    ist: time,
                    status: 'available',
                    student: '',
                    studentTz: 'Asia/Kolkata',
                    note: ''
                }));
            });
            saveData();
        }

        function syncScheduleWithSlots() {
            daysFull.forEach(day => {
                const existing = schedule[day] || [];
                schedule[day] = config.slots.map(time => {
                    const match = existing.find(s => s.ist === time);
                    return match || { ist: time, status: 'available', student: '', studentTz: 'Asia/Kolkata', note: '' };
                });
            });
            saveData();
        }

        function saveData() {
            localStorage.setItem('geniushub_config_v2', JSON.stringify(config));
            localStorage.setItem('geniushub_schedule_v6', JSON.stringify(schedule));
        }

        // --- THEME SYSTEM ---
        function updateGlobalTheme() {
            const now = new Date();
            const hour = parseInt(now.toLocaleTimeString('en-US', { timeZone: 'Asia/Kolkata', hour12: false, hour: '2-digit' }));
            const body = document.body;
            
            body.classList.remove('page-theme-morning', 'page-theme-afternoon', 'page-theme-night', 'bg-slate-50');
            
            if (hour >= 5 && hour < 12) {
                body.classList.add('page-theme-morning');
            } else if (hour >= 12 && hour < 18) {
                body.classList.add('page-theme-afternoon');
            } else {
                body.classList.add('page-theme-night');
            }
        }

        // --- UI INTERACTION ---

        function selectDay(index) {
            currentViewDayIndex = index;
            renderDayNav();
            updateView();
        }

        function renderDayNav() {
            const nav = document.getElementById('day-nav');
            nav.innerHTML = daysFull.map((day, i) => {
                const isActive = i === currentViewDayIndex;
                const activeClass = isActive ? 'tab-active' : 'tab-inactive';
                // Show short name on mobile, full name on md+
                return `
                    <button onclick="selectDay(${i})" class="flex-shrink-0 px-6 py-2 rounded-full border text-sm font-bold transition-all ${activeClass}">
                        <span class="md:hidden">${daysShort[i]}</span>
                        <span class="hidden md:block">${daysFull[i]}</span>
                    </button>
                `;
            }).join('');
            
            // Auto-scroll to active button
            const activeBtn = nav.children[currentViewDayIndex];
            if(activeBtn) {
                activeBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }
        }

        function toggleStatus(day, index) {
            const slot = schedule[day][index];
            if (slot.status === 'available') {
                openBookingModal(day, index);
            } else {
                openManageModal(day, index);
            }
        }

        function openBookingModal(day, index) {
            activeEdit = { day, index };
            const slot = schedule[day][index];
            document.getElementById('modal-title').innerText = `${day} @ ${slot.ist} IST`;
            document.getElementById('student-name-input').value = "";
            document.getElementById('student-note-input').value = "";
            
            const tzInput = document.getElementById('student-tz-input');
            tzInput.innerHTML = config.timezones.map(tz => `<option value="${tz.value}">${tz.label}</option>`).join('');
            tzInput.value = document.getElementById('timezone-select').value;

            document.getElementById('modal-overlay').classList.replace('hidden', 'flex');
            document.getElementById('student-name-input').focus();
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.replace('flex', 'hidden');
            activeEdit = null;
        }

        function saveBooking() {
            if (activeEdit) {
                const name = document.getElementById('student-name-input').value.trim();
                const note = document.getElementById('student-note-input').value.trim();
                const studentTz = document.getElementById('student-tz-input').value;
                if (!name) return;

                const slot = schedule[activeEdit.day][activeEdit.index];
                slot.status = 'booked';
                slot.student = name;
                slot.note = note;
                slot.studentTz = studentTz;
                
                saveData();
                closeModal();
                updateView();
            }
        }

        // --- Manage/WhatsApp Modal ---

        function openManageModal(day, index) {
            activeEdit = { day, index };
            const slot = schedule[day][index];
            document.getElementById('manage-title').innerText = `${day} @ ${slot.ist}`;
            document.getElementById('manage-subtitle').innerText = slot.student;
            document.getElementById('manage-overlay').classList.replace('hidden', 'flex');
        }

        function closeManageModal() {
            document.getElementById('manage-overlay').classList.replace('flex', 'hidden');
            activeEdit = null;
        }

        function confirmUnbook() {
            if (activeEdit) {
                const slot = schedule[activeEdit.day][activeEdit.index];
                slot.status = 'available';
                slot.student = '';
                slot.note = '';
                slot.studentTz = 'Asia/Kolkata';
                saveData();
                closeManageModal();
                updateView();
            }
        }

        function sendWhatsappReminder() {
            if (!activeEdit) return;
            const slot = schedule[activeEdit.day][activeEdit.index];
            
            // Calculate Student's time
            const [h, m] = slot.ist.split(':');
            const refDate = getReferenceDate(daysFull.indexOf(activeEdit.day));
            refDate.setHours(parseInt(h), parseInt(m), 0, 0);
            
            const studentTime = refDate.toLocaleTimeString('en-US', { timeZone: slot.studentTz, hour: 'numeric', minute: '2-digit', hour12: true });
            const studentDay = refDate.toLocaleDateString('en-US', { timeZone: slot.studentTz, weekday: 'long' });
            
            // Construct Message
            let msg = `Hi ${slot.student}, this is a reminder for our session.\n\n`;
            msg += `üìÖ *Time:* ${activeEdit.day}, ${slot.ist} IST`;
            
            if (slot.studentTz !== 'Asia/Kolkata') {
                msg += `\n(Your time: ${studentDay}, ${studentTime})`;
            }
            
            if (config.meetingLink) {
                msg += `\n\nüîó *Link:* ${config.meetingLink}`;
            } else {
                msg += `\n\nüîó *Link:* (Please check your email)`;
            }

            const url = `https://wa.me/?text=${encodeURIComponent(msg)}`;
            window.open(url, '_blank');
        }

        // --- Settings Logic ---
        function addSlot() {
            const input = document.getElementById('new-slot-input');
            const time = input.value;
            if (time && !config.slots.includes(time)) {
                config.slots.push(time);
                config.slots.sort();
                input.value = '';
                renderSettings();
            }
        }

        function removeSlot(idx) {
            config.slots.splice(idx, 1);
            renderSettings();
        }

        function addTimezone() {
            const label = document.getElementById('new-tz-label');
            const value = document.getElementById('new-tz-value');
            if (label.value && value.value) {
                config.timezones.push({ label: label.value, value: value.value });
                label.value = ''; value.value = '';
                renderSettings();
            }
        }

        function removeTimezone(idx) {
            if (config.timezones.length > 1) {
                config.timezones.splice(idx, 1);
                renderSettings();
            }
        }

        function renderSettings() {
            document.getElementById('setting-meeting-link').value = config.meetingLink || '';

            const slotsList = document.getElementById('settings-slots-list');
            slotsList.innerHTML = config.slots.map((s, i) => `<br>
                <div class="flex justify-between items-center p-3 bg-white border rounded-xl shadow-sm">
                    <span class="font-bold text-slate-700">${s} IST</span>
                    <button onclick="removeSlot(${i})" class="text-red-400 font-bold p-1">‚úï</button>
                </div>`).join('');

            const tzList = document.getElementById('settings-tz-list');
            tzList.innerHTML = config.timezones.map((tz, i) => `<br>
                <div class="flex justify-between items-center p-3 bg-white border rounded-xl shadow-sm">
                    <div>
                        <div class="text-xs font-bold text-slate-800">${tz.label}</div>
                        <div class="text-[10px] text-slate-400 font-mono">${tz.value}</div>
                    </div>
                    <button onclick="removeTimezone(${i})" class="text-red-400 font-bold p-1">‚úï</button>
                </div>`).join('');

            const select = document.getElementById('timezone-select');
            const currentVal = select.value;
            select.innerHTML = config.timezones.map(tz => `<option value="${tz.value}">${tz.label}</option>`).join('');
            if (config.timezones.some(t => t.value === currentVal)) select.value = currentVal;
            else if (config.timezones.length > 0) select.value = config.timezones[0].value;
        }

        function openSettingsModal() { 
            renderSettings();
            document.getElementById('settings-overlay').classList.replace('hidden', 'flex');
        }

        function closeSettingsModal() { 
            config.meetingLink = document.getElementById('setting-meeting-link').value.trim();
            saveData();
            syncScheduleWithSlots();
            updateView();
            document.getElementById('settings-overlay').classList.replace('flex', 'hidden');
        }

        function openResetModal() { document.getElementById('reset-overlay').classList.replace('hidden', 'flex'); }
        function closeResetModal() { document.getElementById('reset-overlay').classList.replace('flex', 'hidden'); }
        function confirmReset() { rebuildSchedule(); updateView(); closeResetModal(); }

        // Calculates date for the view logic
        function getReferenceDate(targetDayIndex) {
            const now = new Date();
            const nowIST = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Kolkata"}));
            
            const currentDay = nowIST.getDay(); // 0 is Sunday
            const distFromMonday = currentDay === 0 ? 6 : currentDay - 1;
            
            // Set date to this week's Monday
            const refDate = new Date(nowIST);
            refDate.setDate(nowIST.getDate() - distFromMonday);
            
            // Add target day index
            refDate.setDate(refDate.getDate() + targetDayIndex);
            return refDate;
        }

        function updateView() {
            const select = document.getElementById('timezone-select');
            const viewTz = select.value || 'Asia/Kolkata';
            const container = document.getElementById('schedule-container');
            container.innerHTML = '';

            const mentorDay = daysFull[currentViewDayIndex];
            
            // Header for the specific day view
            // const dayHeader = document.createElement('div');
            // dayHeader.className = "flex items-center gap-3 pb-2";
            // dayHeader.innerHTML = `<h2 class="text-xl font-black text-slate-800 uppercase tracking-tight">${mentorDay}</h2><div class="h-px flex-grow bg-slate-200"></div>`;
            // container.appendChild(dayHeader);

            const grid = document.createElement('div');
            grid.className = "grid grid-cols-1 gap-3 animate-in slide-in-from-right-4 duration-300";

            (schedule[mentorDay] || []).forEach((slot, index) => {
                const [h, m] = slot.ist.split(':');
                const hour = parseInt(h);
                const refDate = getReferenceDate(currentViewDayIndex);
                refDate.setHours(hour, parseInt(m), 0, 0);

                // 1. Time based on the Global Preview Selector (View Time)
                const viewDayName = refDate.toLocaleDateString('en-US', { timeZone: viewTz, weekday: 'long' });
                const viewTimeStr = refDate.toLocaleTimeString('en-US', { timeZone: viewTz, hour: 'numeric', minute: '2-digit', hour12: true });
                
                // 2. Time based on the specific Student's Timezone (if booked)
                let studentSpecificTimeStr = "";
                let studentSpecificDayName = "";
                if (slot.status === 'booked' && slot.studentTz) {
                    studentSpecificDayName = refDate.toLocaleDateString('en-US', { timeZone: slot.studentTz, weekday: 'long' });
                    studentSpecificTimeStr = refDate.toLocaleTimeString('en-US', { timeZone: slot.studentTz, hour: 'numeric', minute: '2-digit', hour12: true });
                }

                // Determine Time Period Class
                let timeClass = 'time-morning';
                let periodLabel = 'Morning';
                
                if (hour >= 12 && hour < 18) {
                    timeClass = 'time-afternoon';
                    periodLabel = 'Afternoon';
                } else if (hour >= 18) {
                    timeClass = 'time-night';
                    periodLabel = 'Night';
                }

                const btn = document.createElement('div');
                btn.className = `p-5 rounded-[2rem] border-2 transition-all flex flex-col gap-3 cursor-pointer ${timeClass} status-${slot.status} shadow-sm active:scale-[0.98]`;
                
                const dayDifference = viewDayName !== mentorDay;

                btn.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex flex-col">
                            <span class="text-[10px] font-bold uppercase opacity-60">Preview Time (${viewTz.split('/').pop()})</span>
                            <span class="text-xl font-black leading-none mt-1">${viewTimeStr}</span>
                            ${dayDifference ? `<span class="mt-1 text-[9px] font-black text-indigo-600 uppercase bg-white/50 px-2 py-0.5 rounded w-fit">Day Shifted: ${viewDayName}</span>` : ''}
                        </div>
                        <div class="text-right flex flex-col items-end">
                            <span class="text-[9px] uppercase font-black px-2 py-0.5 rounded-full bg-white/60 mb-1 border border-black/5">${slot.status === 'booked' ? 'Booked' : periodLabel}</span>
                            <span class="text-xs font-bold opacity-60">IST: ${slot.ist}</span>
                        </div>
                    </div>

                    ${slot.status === 'booked' ? `
                        <div class="pt-3 border-t border-red-200/50 flex flex-col gap-1">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-black truncate flex-grow mr-2 text-red-900">üë§ ${slot.student}</span>
                                <span class="text-[10px] font-bold text-red-600 whitespace-nowrap bg-white/40 px-2 py-1 rounded-lg">${studentSpecificTimeStr} (${slot.studentTz.split('/').pop()})</span>
                            </div>
                            ${studentSpecificDayName !== mentorDay ? `<span class="text-[9px] font-bold text-amber-600 uppercase">‚ö†Ô∏è Their Day: ${studentSpecificDayName}</span>` : ''}
                            ${slot.note ? `<span class="text-[10px] italic text-red-800/70 bg-white/40 p-2 rounded-lg mt-1">${slot.note}</span>` : ''}
                            <div class="mt-2 flex justify-end">
                                <span class="text-[9px] font-bold uppercase bg-white/50 text-red-600 px-2 py-1 rounded">Tap to Manage / WhatsApp</span>    
                            </div>
                        </div>
                    ` : `
                        <div class="pt-2 text-center text-[10px] font-bold uppercase tracking-widest opacity-40 italic">
                            ‚Äî Tap to Book ‚Äî
                        </div>
                    `}
                `;
                btn.onclick = () => toggleStatus(mentorDay, index);
                grid.appendChild(btn);
            });
            container.appendChild(grid);

            document.getElementById('current-ist-clock').innerText = new Date().toLocaleTimeString('en-IN', { timeZone: 'Asia/Kolkata', hour: '2-digit', minute: '2-digit', hour12: true });
        }

        initData();
        renderSettings();
        renderDayNav();
        updateGlobalTheme();
        updateView();

        // Clock Update Loop
        setInterval(() => {
            document.getElementById('current-ist-clock').innerText = new Date().toLocaleTimeString('en-IN', { timeZone: 'Asia/Kolkata', hour: '2-digit', minute: '2-digit', hour12: true });
            updateGlobalTheme();
        }, 10000);

    </script>
</body>
</html>
